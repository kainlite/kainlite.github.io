<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Gabriel" />
    <meta name="description" content="Articles about Kubernetes, CI/CD, Git, Linux, Containers, Golang, and probably some more random stuff, you can subscribe via RSS or JSON Feed.">
    <link rel="shortcut icon" type="image/x-icon" href="https://techsquad.rocks/img/favicon.ico">
    <title>Actually using Vault on Kubernetes</title>
    <meta name="generator" content="Hugo 0.55.6" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://techsquad.rocks/css/main.css" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/tomorrow.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
    <link rel="stylesheet" type="text/css" href="https://techsquad.rocks/css/gruvbox-dark.min.css" />
    
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old" />
    
    <!--[if lt IE 9]>
                        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-8919037-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<meta property="description" content="Introduction In the previous article we configured Vault with Consul on our cluster, now it&rsquo;s time to go ahead and use it to provision secrets to our pods/applications. If you don&rsquo;t remember about it or don&rsquo;t have your Vault already configured you can go to Getting started with HashiCorp Vault on Kubernetes.
In this article we will actually create an example using mutual TLS and provision some secrets to our app, You can find the files used here in this repo." />

    <meta property="og:title" content="Actually using Vault on Kubernetes" />
<meta property="og:description" content="Introduction In the previous article we configured Vault with Consul on our cluster, now it&rsquo;s time to go ahead and use it to provision secrets to our pods/applications. If you don&rsquo;t remember about it or don&rsquo;t have your Vault already configured you can go to Getting started with HashiCorp Vault on Kubernetes.
In this article we will actually create an example using mutual TLS and provision some secrets to our app, You can find the files used here in this repo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://techsquad.rocks/blog/actually_using_vault_on_kubernetes/" />
<meta property="og:image" content="https://techsquad.rocks/img/vault-kubernetes.png?1561505976" />


<meta property="article:tag" content="kubernetes" />
<meta property="article:tag" content="vault" />
<meta property="article:tag" content="linux" />
<meta property="article:tag" content="security" />

<meta property="og:locale" content="en" />


    <meta name="twitter:title" content="Actually using Vault on Kubernetes"/>
<meta name="twitter:description" content="Introduction In the previous article we configured Vault with Consul on our cluster, now it&rsquo;s time to go ahead and use it to provision secrets to our pods/applications. If you don&rsquo;t remember about it or don&rsquo;t have your Vault already configured you can go to Getting started with HashiCorp Vault on Kubernetes.
In this article we will actually create an example using mutual TLS and provision some secrets to our app, You can find the files used here in this repo.?1561505976"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://techsquad.rocks/img/vault-kubernetes.png?1561505976" />


<link rel="publisher" href="https://techsquad.rocks">
<link rel="author" href="https://twitter.com/kainlite">
<meta property="author" content="Tech Squad">
<meta property="og:type" content="article">
<meta name="twitter:card" content="summary_large_image">
<meta property="article:publisher" content="https://techsquad.rocks">
<meta property="article:author" content="https://twitter.com/kainlite">
<meta name="twitter:site" content="@kainlite">
<meta property="og:site_name" content="Tech Squad">

  </head>

  <body>
    <div id="wrap">

      
      <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://techsquad.rocks/"><i class="fa fa-home"></i></a>
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/blog/">BLOG</a></li>
        
      
      </ul>
    </div>
  </div>
</nav>

      

      <div class="modal fade" id="enlargeImageModal" tabindex="-1" role="dialog" aria-labelledby="enlargeImageModal" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <img src="" class="enlargeImageModalSource" style="width: 100%;">
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="blog-post">
          <h3>
            <strong><a href="https://techsquad.rocks/blog/actually_using_vault_on_kubernetes/">Actually using Vault on Kubernetes</a></strong>
          </h3>
        </div>
        <div class="blog-title">
          <h4>
          April 29, 2019
            &nbsp;&nbsp;
            
            
              <a href="https://techsquad.rocks/tags/kubernetes/" class="label label-success">
                    kubernetes
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/vault/" class="label label-success">
                    vault
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/linux/" class="label label-success">
                    linux
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/security/" class="label label-success">
                    security
                  </a>
          </h4>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="blogpost">
              

<h5 id="introduction"><strong>Introduction</strong></h5>

<p>In the previous article we configured Vault with Consul on our cluster, now it&rsquo;s time to go ahead and use it to provision secrets to our pods/applications. If you don&rsquo;t remember about it or don&rsquo;t have your Vault already configured you can go to <a href="https://techsquad.rocks/blog/getting_started_with_hashicorp_vault_on_kubernetes/">Getting started with HashiCorp Vault on Kubernetes</a>.</p>

<p>In this article we will actually create an example using mutual TLS and provision some secrets to our app, You can find the files used here in <a href="https://github.com/kainlite/vault-kubernetes">this repo</a>.</p>

<h5 id="creating-a-cert-for-our-new-client"><strong>Creating a cert for our new client</strong></h5>

<p>As we see here we need to enable kv version 1 on <code>/secret</code> for this to work, then we just create a secret and store it as a kubernetes secret for myapp, note that the CA was created in the previous article and we rely on these certificates so we can keep building on that.
<script type="application/javascript" src="//gist.github.com/kainlite/2989cf05404896f7b65ac400068ac903.js"></script></p>

<h5 id="service-account-for-kubernetes"><strong>Service account for kubernetes</strong></h5>

<p>In Kubernetes, a service account provides an identity for processes that run in a Pod so that the processes can contact the API server.
<script type="application/javascript" src="//gist.github.com/kainlite/8440fe3654d36fb2055c7ceb894f167e.js"></script></p>

<h5 id="vault-policy"><strong>Vault policy</strong></h5>

<p>Then we need to set a read-only policy for our secrets, we don&rsquo;t want or app to be able to write or rewrite secrets.
<script type="application/javascript" src="//gist.github.com/kainlite/aef3234eb43aa37f7cce5f20ecf7c757.js"></script></p>

<h5 id="kubernetes-configuration"><strong>Kubernetes configuration</strong></h5>

<p>Set the environment variables to point to the running Minikube environment and enable the <a href="https://www.vaultproject.io/docs/auth/kubernetes.html#configuration">kubernetes authentication method</a> and then validate it from a temporal Pod.
<script type="application/javascript" src="//gist.github.com/kainlite/a47d22781b177c483bfe706cc436f049.js"></script></p>

<h5 id="the-deployment-and-the-consul-template-configuration"><strong>The deployment and the consul-template configuration</strong></h5>

<p>If you check the volume mounts and the secrets we load the certificates we created initially and use them to fetch the secret from vault
<script type="application/javascript" src="//gist.github.com/kainlite/0cc0e90b668c2fef4d2442e1b9eed03f.js"></script></p>

<p>This is where the magic happens so we&rsquo;re able to fetch secrets (thanks to that role and the token that then will be stored there)
<script type="application/javascript" src="//gist.github.com/kainlite/f977a689000a20c5163ce72cea0039f5.js"></script></p>

<p>And last but not least we create a file based in the template provided which our nginx container will render on the screen later, this is done using Consul Template.
<script type="application/javascript" src="//gist.github.com/kainlite/3dd851d97eba8222dd978a2e7ed067a9.js"></script></p>

<h5 id="test-it"><strong>Test it!</strong></h5>

<p>The last step would be to test all that, so after having deployed the files to kubernetes we should see something like this
<script type="application/javascript" src="//gist.github.com/kainlite/269dd3f96ef2b5505a50513eef9ff94c.js"></script></p>

<h5 id="closing-notes"><strong>Closing notes</strong></h5>

<p>This post was heavily inspired by <a href="https://learn.hashicorp.com/vault/identity-access-management/vault-agent-k8s">this doc page</a>, the main difference is that we have mutual TLS on, the only thing left would be to auto unseal our Vault, but we will left that for a future article or as an exercise for the reader.</p>

<h3 id="errata">Errata</h3>

<p>If you spot any error or have any suggestion, please send me a message so it gets fixed.</p>

<p>Also, you can check the source code and changes in the <a href="https://github.com/kainlite/kainlite.github.io">generated code</a> and the <a href="https://github.com/kainlite/blog">sources here</a></p>

              <hr>
              
              <div class="related-posts">
                <h5>Related Posts</h5>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        June 24, 2019
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/getting_started_with_terraform_modules/">Getting started with terraform modules</a></strong>
                      </h6>
                    </div>
                  </div>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        May 5, 2019
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/go_continuous_delivery_with_terraform_and_kubernetes/">Go continuous delivery with Terraform and Kubernetes</a></strong>
                      </h6>
                    </div>
                  </div>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        May 1, 2019
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/go_continuous_integration_with_travis_ci_and_docker/">Go continuous integration with Travis CI and Docker</a></strong>
                      </h6>
                    </div>
                  </div>
                
              </div>
            </div>
          </div>
          
          <hr>
        <div class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">

    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;

      var disqus_shortname = 'kainlite';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        </div>
      </div>
      
    </div>

    
    <footer>
  <div id="footer">
    <div class="container">
      <p class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
      <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with ♥</p>
    </div>
  </div>
</footer>
<div class="footer"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://techsquad.rocks/js/docs.min.js"></script>
<script src="https://techsquad.rocks/js/main.js"></script>

<script src="https://techsquad.rocks/js/ie10-viewport-bug-workaround.js"></script><!-- Syntax highlighting -->
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  </body>
</html>
