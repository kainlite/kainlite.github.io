<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Brief introduction to terratest - Kubernetes, CI/CD, Git, Linux, Containers, Golang... and more
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="Introduction In this article we will see the basics to have tests for your terraform code using a re-usable pattern, we will use the code from the last article Serverless authentication with Cognito, so refer to that one before starting this one if you want to know how did we get here. Also as a side note this is a very basic example on how to get started with terratest." />
  <meta name="generator" content="Hugo 0.78.1 with theme pure" />
  <title>Brief introduction to terratest - Kubernetes, CI/CD, Git, Linux, Containers, Golang... and more</title>
  
  
  <link rel="stylesheet" href="https://techsquad.rocks/css/style.min.7dc20efbc53647d41aa9ddea0c48e59300223d084e66ea0cbe7c30bd88903acc.css">
  
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="Brief introduction to terratest" />
<meta property="og:description" content="Introduction In this article we will see the basics to have tests for your terraform code using a re-usable pattern, we will use the code from the last article Serverless authentication with Cognito, so refer to that one before starting this one if you want to know how did we get here. Also as a side note this is a very basic example on how to get started with terratest." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://techsquad.rocks/blog/brief_introduction_to_terratest/" />
<meta property="og:image" content="https://techsquad.rocks/img/logo.png"/>
<meta property="article:published_time" content="2019-09-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-08T00:00:00+00:00" />
<meta itemprop="name" content="Brief introduction to terratest">
<meta itemprop="description" content="Introduction In this article we will see the basics to have tests for your terraform code using a re-usable pattern, we will use the code from the last article Serverless authentication with Cognito, so refer to that one before starting this one if you want to know how did we get here. Also as a side note this is a very basic example on how to get started with terratest.">
<meta itemprop="datePublished" content="2019-09-08T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-09-08T00:00:00+00:00" />
<meta itemprop="wordCount" content="950">
<meta itemprop="image" content="https://techsquad.rocks/img/logo.png"/>



<meta itemprop="keywords" content="go,golang,development,linux,terraform," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://techsquad.rocks/img/logo.png"/>

<meta name="twitter:title" content="Brief introduction to terratest"/>
<meta name="twitter:description" content="Introduction In this article we will see the basics to have tests for your terraform code using a re-usable pattern, we will use the code from the last article Serverless authentication with Cognito, so refer to that one before starting this one if you want to know how did we get here. Also as a side note this is a very basic example on how to get started with terratest."/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/kainlite" target="_blank">
            <img class="img-circle img-rotate" src="https://techsquad.rocks/img/logo-glider.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">kainlite</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">DevOps Practitioner</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Mendoza, Argentina</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-blog">
                <a href="/blog/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Blog</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://techsquad.rocks/blog/testing_the_operator_sdk_and_making_a_prefetch_mechanism_for_kubernetes/" class="title">Testing the Operator SDK and making a prefetch mechanism for Kubernetes</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-11-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-11-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://techsquad.rocks/blog/terraform_linter/" class="title">Automatic terraform linting with reviewdog and tflint</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-05-21 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-05-21</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://techsquad.rocks/blog/gitlab_ci_basics/" class="title">Gitlab-CI Basics</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-02-02 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-02-02</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://techsquad.rocks/blog/cat_and_friends_netcat_socat/" class="title">Cat and friends (Netcat and Socat)</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-01-20 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-01-20</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://techsquad.rocks/blog/cloud_native_applications_with_kubebuilder_and_kind_aka_kubernetes_operators/" class="title">Cloud native applications with kubebuilder and kind aka kubernetes operators</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-01-17 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-01-17</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div><div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/continuous-integration/" class="category-list-link">continuous-integration</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/deployment-tools/" class="category-list-link">deployment-tools</a><span class="category-list-count">6</span></li>
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/kubernetes/" class="category-list-link">kubernetes</a><span class="category-list-count">8</span></li>
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/linux/" class="category-list-link">linux</a><span class="category-list-count">10</span></li>
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/serverless/" class="category-list-link">serverless</a><span class="category-list-count">10</span></li>
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/service-mesh/" class="category-list-link">service-mesh</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://techsquad.rocks/categories/terraform/" class="category-list-link">terraform</a><span class="category-list-count">1</span></li>
        </ul>
    </div>
</div><div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/aws/" class="tag-list-link">aws</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/cognito/" class="tag-list-link">cognito</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/continuous-delivery/" class="tag-list-link">continuous-delivery</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/continuous-integration/" class="tag-list-link">continuous-integration</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/deployment-tools/" class="tag-list-link">deployment-tools</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/development/" class="tag-list-link">development</a><span
                    class="tag-list-count">9</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/docker/" class="tag-list-link">docker</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/elm/" class="tag-list-link">elm</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/gcp/" class="tag-list-link">gcp</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/git/" class="tag-list-link">git</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/github/" class="tag-list-link">github</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/gitkube/" class="tag-list-link">gitkube</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/gitlab/" class="tag-list-link">gitlab</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/go/" class="tag-list-link">go</a><span
                    class="tag-list-count">13</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/golang/" class="tag-list-link">golang</a><span
                    class="tag-list-count">12</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/grpc/" class="tag-list-link">grpc</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/helm/" class="tag-list-link">helm</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/istio/" class="tag-list-link">istio</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/jsonnet/" class="tag-list-link">jsonnet</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/kind/" class="tag-list-link">kind</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/kops/" class="tag-list-link">kops</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/ksonnet/" class="tag-list-link">ksonnet</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/kubebuilder/" class="tag-list-link">kubebuilder</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/kubernetes/" class="tag-list-link">kubernetes</a><span
                    class="tag-list-count">15</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/kustomize/" class="tag-list-link">kustomize</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/lambda/" class="tag-list-link">lambda</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/linux/" class="tag-list-link">linux</a><span
                    class="tag-list-count">17</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/networking/" class="tag-list-link">networking</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/openssh/" class="tag-list-link">openssh</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/routing/" class="tag-list-link">routing</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/security/" class="tag-list-link">security</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/serverless/" class="tag-list-link">serverless</a><span
                    class="tag-list-count">8</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/service-mesh/" class="tag-list-link">service-mesh</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/skaffold/" class="tag-list-link">skaffold</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/slack/" class="tag-list-link">slack</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/terraform/" class="tag-list-link">terraform</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/tips-and-tricks/" class="tag-list-link">tips-and-tricks</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/tmux/" class="tag-list-link">tmux</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/travis-ci/" class="tag-list-link">travis-ci</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/urxvt/" class="tag-list-link">urxvt</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/vault/" class="tag-list-link">vault</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://techsquad.rocks/tags/vim/" class="tag-list-link">vim</a><span
                    class="tag-list-count">2</span></li>
            
        </ul>

    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">Catalogue</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/blog/brief_introduction_to_terratest/"
    >Brief introduction to terratest</a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://techsquad.rocks/blog/brief_introduction_to_terratest/" class="article-date">
  <time datetime="2019-09-08 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-09-08</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/serverless/"> serverless </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/go/"> go </a>
    <a class="article-tag-link" href="/tags/golang/"> golang </a>
    <a class="article-tag-link" href="/tags/development/"> development </a>
    <a class="article-tag-link" href="/tags/linux/"> linux </a>
    <a class="article-tag-link" href="/tags/terraform/"> terraform </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/blog/brief_introduction_to_terratest/#comments"
            class="article-comment-link">Comments</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount"> Word Count: 950 words</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired"> Read Count: 5 minutes </span>

      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h5 id="introduction"><strong>Introduction</strong></h5>
<p>In this article we will see the basics to have tests for your terraform code using a re-usable pattern, we will use the code from the last article <a href="https://techsquad.rocks/blog/serverless_authentication_with_cognito_and_golang/">Serverless authentication with Cognito</a>, so refer to that one before starting this one if you want to know how did we get here. Also as a side note this is a very basic example on how to get started with terratest.</p>
<p><a href="https://github.com/gruntwork-io/terratest">Terratest</a> is a Go library that makes it easier to write automated tests for your infrastructure code, it supports Terraform, Docker, Packer, SSH, AWS, GCP, Kubernetes, Helm, and much more, also as it&rsquo;s written as a Go library you have access to all the existing APIs.</p>
<h5 id="the-code"><strong>The code</strong></h5>
<p>There are comments all over the code to explain each part, but what I want to highlight here is the pattern being used with the module <code>test-structure</code>, this module allows us to split the test in sections and skip parts that we don&rsquo;t need or want to run, so we have 3 stages here: <code>cleanup</code>, <code>deploy</code>, and <code>validate</code>, this lets you use <code>SKIP_stage</code>, for example <code>SKIP_cleanup</code> when you run your tests with <code>go test -timeout 90m .</code> (I added some extra bits, that I usually use, like timeout by default it&rsquo;s 10 minutes I believe and it&rsquo;s often too short), to only run <code>validate</code> and <code>cleanup</code>, it can be useful while developing a module to test without having to wait for everything to be re-created.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">test</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;crypto/tls&#34;</span>
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;testing&#34;</span>
    <span style="color:#e6db74">&#34;time&#34;</span>

    <span style="color:#a6e22e">http_helper</span> <span style="color:#e6db74">&#34;github.com/gruntwork-io/terratest/modules/http-helper&#34;</span>
    <span style="color:#e6db74">&#34;github.com/gruntwork-io/terratest/modules/retry&#34;</span>
    <span style="color:#e6db74">&#34;github.com/gruntwork-io/terratest/modules/terraform&#34;</span>
    <span style="color:#a6e22e">test_structure</span> <span style="color:#e6db74">&#34;github.com/gruntwork-io/terratest/modules/test-structure&#34;</span>
)

<span style="color:#75715e">// Main function, define stages and run.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestTerraformAws</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Parallel</span>()

    <span style="color:#75715e">// Pick a random AWS region to test in. This helps ensure your code works in all regions.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// awsRegion := aws.GetRandomStableRegion(t, nil, nil)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">awsRegion</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;us-east-1&#34;</span>

    <span style="color:#a6e22e">workingDir</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;../terraform&#34;</span>

    <span style="color:#75715e">// At the end of the test, undeploy the web app using Terraform
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">test_structure</span>.<span style="color:#a6e22e">RunTestStage</span>(<span style="color:#a6e22e">t</span>, <span style="color:#e6db74">&#34;cleanup&#34;</span>, <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">destroyTerraform</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">workingDir</span>)
    })

    <span style="color:#75715e">// Deploy the web app using Terraform
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">test_structure</span>.<span style="color:#a6e22e">RunTestStage</span>(<span style="color:#a6e22e">t</span>, <span style="color:#e6db74">&#34;deploy&#34;</span>, <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">deployTerraform</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">awsRegion</span>, <span style="color:#a6e22e">workingDir</span>)
    })

    <span style="color:#75715e">// Validate that the ASG deployed and is responding to HTTP requests
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">test_structure</span>.<span style="color:#a6e22e">RunTestStage</span>(<span style="color:#a6e22e">t</span>, <span style="color:#e6db74">&#34;validate&#34;</span>, <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">validateAPIGateway</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">workingDir</span>)
    })
}

<span style="color:#75715e">// Validate that the API Gateway has been deployed and is working
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">validateAPIGateway</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">workingDir</span> <span style="color:#66d9ef">string</span>) {
    <span style="color:#75715e">// Load the Terraform Options saved by the earlier deploy_terraform stage
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">terraformOptions</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">test_structure</span>.<span style="color:#a6e22e">LoadTerraformOptions</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">workingDir</span>)

    <span style="color:#75715e">// Run `terraform output` to get the value of an output variable
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">terraform</span>.<span style="color:#a6e22e">Output</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">terraformOptions</span>, <span style="color:#e6db74">&#34;URL&#34;</span>)

    <span style="color:#75715e">// It can take a few minutes for the API GW and CloudFront to finish spinning up, so retry a few times
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//  maxRetries := 30
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">timeBetweenRetries</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">15</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>

    <span style="color:#75715e">// Setup a TLS configuration to submit with the helper, a blank struct is acceptable
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tlsConfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Config</span>{}

    <span style="color:#75715e">// Verify that the API Gateway returns a proper response
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">apigw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">retry</span>.<span style="color:#a6e22e">DoInBackgroundUntilStopped</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Check URL %s&#34;</span>, <span style="color:#a6e22e">url</span>), <span style="color:#a6e22e">timeBetweenRetries</span>, <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">http_helper</span>.<span style="color:#a6e22e">HttpGetWithCustomValidation</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s/app/health&#34;</span>, <span style="color:#a6e22e">url</span>), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tlsConfig</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">statusCode</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">body</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">statusCode</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
        })
    })

    <span style="color:#75715e">// Stop checking the API Gateway
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">apigw</span>.<span style="color:#a6e22e">Done</span>()
}

<span style="color:#75715e">// Deploy the resources using Terraform
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deployTerraform</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">awsRegion</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">workingDir</span> <span style="color:#66d9ef">string</span>) {
    <span style="color:#a6e22e">terraformOptions</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">terraform</span>.<span style="color:#a6e22e">Options</span>{
        <span style="color:#75715e">// The path to where our Terraform code is located
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">TerraformDir</span>: <span style="color:#a6e22e">workingDir</span>,
    }

    <span style="color:#75715e">// Save the Terraform Options struct, instance name, and instance text so future test stages can use it
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">test_structure</span>.<span style="color:#a6e22e">SaveTerraformOptions</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">workingDir</span>, <span style="color:#a6e22e">terraformOptions</span>)

    <span style="color:#75715e">// This will run `terraform init` and `terraform apply` and fail the test if there are any errors
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">terraform</span>.<span style="color:#a6e22e">InitAndApply</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">terraformOptions</span>)
}

<span style="color:#75715e">// Destroy the resources using Terraform
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">destroyTerraform</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">workingDir</span> <span style="color:#66d9ef">string</span>) {
    <span style="color:#75715e">// Load the Terraform Options saved by the earlier deploy_terraform stage
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">terraformOptions</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">test_structure</span>.<span style="color:#a6e22e">LoadTerraformOptions</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">workingDir</span>)

    <span style="color:#a6e22e">terraform</span>.<span style="color:#a6e22e">Destroy</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">terraformOptions</span>)
}
</code></pre></div>
Some high level notes on each stage:</p>
<p><code>deploy</code>: This stage will take care of running init and then apply.</p>
<p><code>validate</code>: This stage will take care of running a probe to check if our API is up and if the return code is <code>200</code>.</p>
<p><code>cleanup</code>: This stage will take care of running destroy and cleaning up everything.</p>
<h5 id="dep"><strong>Dep</strong></h5>
<p>Currently terratest uses dep, so you will need this file <code>Gopkg.toml</code> and <code>dep</code> installed to be able to install the dependencies with <code>dep ensure -v</code>.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[[<span style="color:#a6e22e">constraint</span>]]
  <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;github.com/gruntwork-io/terratest&#34;</span>
  <span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;0.18.6&#34;</span></code></pre></div></p>
<h5 id="dockerfile"><strong>Dockerfile</strong></h5>
<p>Also you can use this small dockerfile that does all that for you, in this example using the code from the previously mentioned article.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">FROM golang:alpine
MAINTAINER <span style="color:#e6db74">&#34;kainlite &lt;kainlite@gmail.com&gt;&#34;</span>

ARG TERRAFORM_VERSION<span style="color:#f92672">=</span>0.12.8
ENV TERRAFORM_VERSION<span style="color:#f92672">=</span>$TERRAFORM_VERSION

RUN apk --no-cache add curl git unzip gcc g++ make ca-certificates <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh

RUN mkdir tmp <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    curl <span style="color:#e6db74">&#34;https://releases.hashicorp.com/terraform/</span><span style="color:#e6db74">${</span>TERRAFORM_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">/terraform_</span><span style="color:#e6db74">${</span>TERRAFORM_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">_linux_amd64.zip&#34;</span> -o tmp/terraform.zip <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    unzip tmp/terraform.zip -d /usr/local/bin <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    rm -rf tmp/

ARG GOPROJECTPATH<span style="color:#f92672">=</span>/go/src/github.com/kainlite/serverless-cognito
COPY ./ $GOPROJECTPATH

WORKDIR $GOPROJECTPATH/test

RUN dep ensure -v

CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;go&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>, <span style="color:#e6db74">&#34; -timeout&#34;</span>, <span style="color:#e6db74">&#34;90m&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">]</span></code></pre></div></p>
<h5 id="manually-testing-it"><strong>Manually testing it</strong></h5>
<p>First we check that the URL actually works, and that everything is in place.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl https://api.skynetng.pw/app/health
<span style="color:#75715e"># OUTPUT:</span>
<span style="color:#75715e"># {&#34;status&#34;:&#34;healthy&#34;}</span></code></pre></div></p>
<p>Next we can test it using our validate stage, using terratest:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ SKIP_deploy<span style="color:#f92672">=</span>true SKIP_cleanup<span style="color:#f92672">=</span>true go test -timeout 90m .
<span style="color:#75715e"># OUTPUT:</span>
<span style="color:#75715e"># ok      github.com/kainlite/test        1.117s</span></code></pre></div>
This works because in the terraform code we have an output called <code>URL</code> which is <code>https://api.skynetng.pw</code>, then we add at the end <code>/app/health</code> and check if it return a <code>200</code> code, otherwise we wait and retry until it does or times out.</p>
<h3 id="closing-notes">Closing notes</h3>
<p>And that&rsquo;s all for now, in the next piece I will cover how to automate this deployment using a CI/CD tool, so you can have truly repeatable infrastructure, which can be of big importance when working on various modules, versions and deployments.</p>
<h3 id="errata">Errata</h3>
<p>If you spot any error or have any suggestion, please send me a message so it gets fixed.</p>
<p>Also, you can check the source code and changes in the <a href="https://github.com/kainlite/kainlite.github.io">generated code</a> and the <a href="https://github.com/kainlite/blog">sources here</a></p>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://techsquad.rocks/blog/brief_introduction_to_terratest/" title="Brief introduction to terratest" target="_blank" rel="external">https://techsquad.rocks/blog/brief_introduction_to_terratest/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License：</strong><a href="https://github.com/kainlite/blog/blob/master/LICENSE.md" target="_blank" rel="external">MIT License</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/kainlite" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://techsquad.rocks/img/logo-glider.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/kainlite" target="_blank"><span class="text-dark">kainlite</span><small class="ml-1x">DevOps Practitioner</small></a></h3>
        <div>Articles about Kubernetes, CI/CD, Git, Linux, Containers, Golang, and probably some more random stuff, you can subscribe via RSS or JSON Feed.</div>
      </div>
    </figure>
  </div>
</div>

    </div>
  </article>
<section id="comments">
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://techsquad.rocks/blog/serverless_authentication_with_cognito_and_golang/" title="Serverless authentication with Cognito and Go"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://techsquad.rocks/blog/how_to_report_your_gmail_spam_folder_to_spamcop/"
                    title="How to report your gmail spam folder to spamcop"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="facebook,twitter,google,linkedin"
                data-mobile-sites=""></div>
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><script>
(function buymeacoffee() {
  var buymeacoffee = document.createElement('script');
  buymeacoffee.setAttribute('src','https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js');
  buymeacoffee.async = true;
  buymeacoffee.setAttribute('data-id','NDx5OFh');
  buymeacoffee.setAttribute('data-name','BMC-Widget');
  buymeacoffee.setAttribute('data-description','Support me on Buy me a coffee!');
  buymeacoffee.setAttribute('data-message','Thank you for visiting. You can now buy me a coffee!');
  buymeacoffee.setAttribute('data-color','#79D6B5');
  buymeacoffee.setAttribute('data-position','right');
  buymeacoffee.setAttribute('data-x_margin','10');
  buymeacoffee.setAttribute('data-y_margin','10');

  
  
  

  

  
  
  

  
  
  
  
  
  document.getElementsByTagName('head')[0].appendChild(buymeacoffee);
})()
</script>

<ul class="social-links">
    <li><a href="mailto:kainlite@gmail.com" target="_blank" title="email" data-toggle=tooltip data-placement=top >
            <i class="icon icon-email"></i></a></li>
    <li><a href="https://github.com/kainlite" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://www.linkedin.com/in/gabrielgarrido/" target="_blank" title="linkedin" data-toggle=tooltip data-placement=top >
            <i class="icon icon-linkedin"></i></a></li>
    <li><a href="https://techsquad.rocks/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
    <li><a href="https://techsquad.rocks/index.json" target="_blank" title="share" data-toggle=tooltip data-placement=top >
            <i class="icon icon-share"></i></a></li>
    <li><a href="https://stackoverflow.com/users/313941/kainlite" target="_blank" title="stackoverflow" data-toggle=tooltip data-placement=top >
            <i class="icon icon-stackoverflow"></i></a></li>
    <li><a href="https://twitter.com/kainlite" target="_blank" title="twitter" data-toggle=tooltip data-placement=top >
            <i class="icon icon-twitter"></i></a></li>
</ul>

  <div class="copyright">
    <div class="publishby">
        © All rights reserved. Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> and <a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank">Pure</a> with ♥
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/bash.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/go.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/yaml.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://techsquad.rocks/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://techsquad.rocks/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/techsquad.rocks\/',
            CONTENT_URL: 'https:\/\/techsquad.rocks\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://techsquad.rocks/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>

<script>
if (window.location.hostname !== "localhost") {
    var disqus_config = function () {
        this.page.url = 'https:\/\/techsquad.rocks\/blog\/brief_introduction_to_terratest\/';
        this.page.identifier = 'https:\/\/techsquad.rocks\/blog\/brief_introduction_to_terratest\/';
    };
    (function () {
        var d = document, s = d.createElement('script');
        s.src = '//' + 'kainlite' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
}
</script>
<script id="dsq-count-scr" src="//kainlite.disqus.com/count.js" async></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-8919037-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    <script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
  </body>
</html>
