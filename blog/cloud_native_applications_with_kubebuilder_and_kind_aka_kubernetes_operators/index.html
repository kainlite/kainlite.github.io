<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Gabriel" />
    <meta name="description" content="Articles about Kubernetes, CI/CD, Git, Linux, Containers, Golang, and probably some more random stuff, you can subscribe via RSS or JSON Feed.">
    <link rel="shortcut icon" type="image/x-icon" href="https://techsquad.rocks/img/favicon.ico">
    <title>Cloud native applications with kubebuilder and kind aka kubernetes operators</title>
    <meta name="generator" content="Hugo 0.63.2" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://techsquad.rocks/css/main.css" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/tomorrow.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
    <link rel="stylesheet" type="text/css" href="https://techsquad.rocks/css/gruvbox-dark.min.css" />
    
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old" />
    
    <!--[if lt IE 9]>
                        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-8919037-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<meta property="description" content="Introduction In this article we will see how to use kubebuilder and Kind to create a local test cluster and an operator, then deploy that operator in the cluster and test it, the repository with the files can be found here, also if you want to learn more about the idea and the project go: forward.
Basically what the code does is create an alpine/socat pod and you can specify the host, port and protocol and it will make a tunnel for you, so then you can use port-forward or a service or ingress or whatever to expose things that are in another private subnet, while this might not sound like a good idea it has some use cases, so check your security constraints before doing any of that in a normal scenario it should be safe, it can be useful for testing or for reaching a DB while doing some debugging or test, but well, that is for another discussion, the tools used here is what makes this so interesting, this is a cloud native application, since it native to kubernetes and that&rsquo;s what we will explore here." />

    <meta property="og:title" content="Cloud native applications with kubebuilder and kind aka kubernetes operators" />
<meta property="og:description" content="Introduction In this article we will see how to use kubebuilder and Kind to create a local test cluster and an operator, then deploy that operator in the cluster and test it, the repository with the files can be found here, also if you want to learn more about the idea and the project go: forward.
Basically what the code does is create an alpine/socat pod and you can specify the host, port and protocol and it will make a tunnel for you, so then you can use port-forward or a service or ingress or whatever to expose things that are in another private subnet, while this might not sound like a good idea it has some use cases, so check your security constraints before doing any of that in a normal scenario it should be safe, it can be useful for testing or for reaching a DB while doing some debugging or test, but well, that is for another discussion, the tools used here is what makes this so interesting, this is a cloud native application, since it native to kubernetes and that&rsquo;s what we will explore here." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://techsquad.rocks/blog/cloud_native_applications_with_kubebuilder_and_kind_aka_kubernetes_operators/" />
<meta property="og:image" content="https://techsquad.rocks/img/forward.jpg?1580700688" />


<meta property="article:tag" content="go" />
<meta property="article:tag" content="golang" />
<meta property="article:tag" content="kubernetes" />
<meta property="article:tag" content="linux" />
<meta property="article:tag" content="security" />
<meta property="article:tag" content="docker" />
<meta property="article:tag" content="kustomize" />
<meta property="article:tag" content="kubebuilder" />
<meta property="article:tag" content="kind" />

<meta property="og:locale" content="en" />


    <meta name="twitter:title" content="Cloud native applications with kubebuilder and kind aka kubernetes operators"/>
<meta name="twitter:description" content="Introduction In this article we will see how to use kubebuilder and Kind to create a local test cluster and an operator, then deploy that operator in the cluster and test it, the repository with the files can be found here, also if you want to learn more about the idea and the project go: forward.
Basically what the code does is create an alpine/socat pod and you can specify the host, port and protocol and it will make a tunnel for you, so then you can use port-forward or a service or ingress or whatever to expose things that are in another private subnet, while this might not sound like a good idea it has some use cases, so check your security constraints before doing any of that in a normal scenario it should be safe, it can be useful for testing or for reaching a DB while doing some debugging or test, but well, that is for another discussion, the tools used here is what makes this so interesting, this is a cloud native application, since it native to kubernetes and that&rsquo;s what we will explore here.?1580700688"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://techsquad.rocks/img/forward.jpg?1580700688" />


<link rel="publisher" href="https://techsquad.rocks">
<link rel="author" href="https://twitter.com/kainlite">
<meta property="author" content="Tech Squad">
<meta property="og:type" content="article">
<meta name="twitter:card" content="summary_large_image">
<meta property="article:publisher" content="https://techsquad.rocks">
<meta property="article:author" content="https://twitter.com/kainlite">
<meta name="twitter:site" content="@kainlite">
<meta property="og:site_name" content="Tech Squad">

  </head>

  <body>
    <div id="wrap">

      
      <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://techsquad.rocks/"><i class="fa fa-home"></i></a>
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/blog/">BLOG</a></li>
        
      
      </ul>
    </div>
  </div>
</nav>

      

      <div class="modal fade" id="enlargeImageModal" tabindex="-1" role="dialog" aria-labelledby="enlargeImageModal" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
            </div>
            <div class="modal-body">
              <img src="" class="enlargeImageModalSource" style="width: 100%;">
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="blog-post">
          <h3>
            <strong><a href="https://techsquad.rocks/blog/cloud_native_applications_with_kubebuilder_and_kind_aka_kubernetes_operators/">Cloud native applications with kubebuilder and kind aka kubernetes operators</a></strong>
          </h3>
        </div>
        <div class="blog-title">
          <h4>
          January 17, 2020
            &nbsp;&nbsp;
            
            
              <a href="https://techsquad.rocks/tags/go/" class="label label-success">
                    go
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/golang/" class="label label-success">
                    golang
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/kubernetes/" class="label label-success">
                    kubernetes
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/linux/" class="label label-success">
                    linux
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/security/" class="label label-success">
                    security
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/docker/" class="label label-success">
                    docker
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/kustomize/" class="label label-success">
                    kustomize
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/kubebuilder/" class="label label-success">
                    kubebuilder
                  </a>&nbsp; <a href="https://techsquad.rocks/tags/kind/" class="label label-success">
                    kind
                  </a>
          </h4>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="blogpost">
              <h5 id="introduction"><strong>Introduction</strong></h5>
<p>In this article we will see how to use <a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a> and <a href="https://github.com/kubernetes-sigs/kind">Kind</a> to create a local test cluster and an operator, then deploy that operator in the cluster and test it, the repository with the files can be found here, also if you want to learn more about the idea and the project go: <a href="https://github.com/kainlite/forward">forward</a>.</p>
<p>Basically what the code does is create an alpine/socat pod and you can specify the host, port and protocol and it will make a tunnel for you, so then you can use port-forward or a service or ingress or whatever to expose things that are in another private subnet, while this might not sound like a good idea it has some use cases, so check your security constraints before doing any of that in a normal scenario it should be safe, it can be useful for testing or for reaching a DB while doing some debugging or test, but well, that is for another discussion, the tools used here is what makes this so interesting, this is a cloud native application, since it native to kubernetes and that&rsquo;s what we will explore here.</p>
<p>While Kind is not actually a requirement I used that for testing and really liked it, it&rsquo;s faster and simpler than minikube.</p>
<p>Also if you are interested how I got the idea to make this operator check this <a href="https://github.com/kubernetes/kubernetes/issues/72597">github issue</a>.</p>
<h5 id="prerequisites"><strong>Prerequisites</strong></h5>
<ul>
<li><a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a></li>
<li><a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a></li>
<li><a href="https://golang.org/dl/">Go 1.13</a></li>
<li><a href="https://github.com/kubernetes-sigs/kind">Kind</a></li>
<li><a href="https://hub.docker.com/?overlay=onboarding">Docker</a></li>
</ul>
<h5 id="create-the-project">Create the project</h5>
<p>In this step we need to create the kubebuilder project, so in an empty folder we run:
<script type="application/javascript" src="https://gist.github.com/kainlite/fcb512051b1f9aa1abb7ee9d8fd177f5.js"></script>
</p>
<h5 id="create-the-api">Create the API</h5>
<p>Next let&rsquo;s create an API, something for us to have control of (our controller).
<script type="application/javascript" src="https://gist.github.com/kainlite/99c415e6bbaf6d92b2c971acddc42221.js"></script>
</p>
<p>Right until here we only have some boilerplate and basic or empty project with defaults, if you test it now it will work, but it won&rsquo;t do anything interesting, but it covers a lot of ground and we should be grateful that such a tool exists.</p>
<h5 id="add-our-code-to-the-mix">Add our code to the mix</h5>
<p>First we will add it to <code>api/v1beta1/map_types.go</code>, which will add our fields to our type.
<script type="application/javascript" src="https://gist.github.com/kainlite/6e823ba4160fb12b9414494c9b16be7b.js"></script>

Basically we just edited the <code>MapSpec</code> and the <code>MapStatus</code> struct.</p>
<p>Now we need to add the code to our controller in <code>controllers/map_controller.go</code>
<script type="application/javascript" src="https://gist.github.com/kainlite/d2e59c468a6864a96647054ac616285d.js"></script>

In this controller we added two functions one to create a pod and modified basically the entire Reconcile function (this one takes care of checking the status and make the transitions in other words makes a controller work like a controller), also notice the kubebuilder annotations which will generate the rbac config for us, pretty handy! right?</p>
<h5 id="starting-the-cluster">Starting the cluster</h5>
<p>Now we will use <a href="https://github.com/kubernetes-sigs/kind">Kind</a> to create a local cluster to test
<script type="application/javascript" src="https://gist.github.com/kainlite/3d5c7eb58a0ede8e34f0824d927deeca.js"></script>

it could be that easy!?!?! yes, it is!</p>
<h5 id="running-our-operator-locally">Running our operator locally</h5>
<p>For testing you can run your operator locally like this:
<script type="application/javascript" src="https://gist.github.com/kainlite/8184c8ae455e033602b81965cacf593b.js"></script>
</p>
<h5 id="testing-it">Testing it</h5>
<p>First we spin up a pod, and launch <code>nc -l -p 8000</code>
<script type="application/javascript" src="https://gist.github.com/kainlite/d940b280bd2f3fdf732b9b259e9da841.js"></script>
</p>
<p>Then we edit our manifest and apply it, check that everything is in place, and do the port-forward and launch another <code>nc localhost 8000</code> to test if everything went well.
First the manifest
<script type="application/javascript" src="https://gist.github.com/kainlite/d609ef25c2bc621d365781e6f3d9826b.js"></script>

Then the port-forward and test
<script type="application/javascript" src="https://gist.github.com/kainlite/d9455e6a17b2a396f486d48cf159f5f2.js"></script>
</p>
<h5 id="making-it-publicly-ready">Making it publicly ready</h5>
<p>Here we just build and push the docker image to dockerhub or our favorite public registry.
<script type="application/javascript" src="https://gist.github.com/kainlite/c45158dd378d09b82c8153dbdd122953.js"></script>

Then you can install it with <code>make deploy IMG=kainlite/forward:0.0.1</code> and uninstall it with <code>make uninstall</code></p>
<h5 id="closing-notes"><strong>Closing notes</strong></h5>
<p>Be sure to check the <a href="https://book.kubebuilder.io/">kubebuilder book</a> if you want to learn more and the <a href="https://kind.sigs.k8s.io/docs/user/quick-start">kind docs</a>, I hope you enjoyed it and hope to see you on <a href="https://twitter.com/kainlite">twitter</a> or <a href="https://github.com/kainlite">github</a>!</p>
<h3 id="errata">Errata</h3>
<p>If you spot any error or have any suggestion, please send me a message so it gets fixed.</p>
<p>Also, you can check the source code and changes in the <a href="https://github.com/kainlite/kainlite.github.io">generated code</a> and the <a href="https://github.com/kainlite/blog">sources here</a></p>

              <hr>
              
              <div class="related-posts">
                <h5>Related Posts</h5>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        February 2, 2020
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/gitlab_ci_basics/">Gitlab-CI Basics</a></strong>
                      </h6>
                    </div>
                  </div>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        January 20, 2020
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/cat_and_friends_netcat_socat/">Cat and friends (Netcat and Socat)</a></strong>
                      </h6>
                    </div>
                  </div>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        January 4, 2020
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/how_to_report_spam_to_spamcop_from_gmail/">How to report spam to spamcop from gmail</a></strong>
                      </h6>
                    </div>
                  </div>
                
              </div>
            </div>
          </div>
          
          <hr>
        <div class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">

    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;

      var disqus_shortname = 'kainlite';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        </div>
      </div>
      
    </div>

    
    <script data-name="BMC-Widget" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="NDx5OFh" data-description="Support me on Buy me a coffee!" data-message="Thank you for visiting. You can now buy me a coffee!" data-color="#79D6B5" data-position="right" data-x_margin="10" data-y_margin="10"></script>


<footer>
  <div id="footer">
    <div class="container">
      <p class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
      <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with â™¥</p>
    </div>
  </div>
</footer>
<div class="footer"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://techsquad.rocks/js/docs.min.js"></script>
<script src="https://techsquad.rocks/js/main.js"></script>

<script src="https://techsquad.rocks/js/ie10-viewport-bug-workaround.js"></script><!-- Syntax highlighting -->
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  </body>
</html>
