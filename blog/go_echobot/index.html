<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Gabriel" />
    <meta name="description" content="Tech ideas, tests, examples...">
    <link rel="shortcut icon" type="image/x-icon" href="https://kainlite.github.io/img/favicon.ico">
    <title>Go echo bot</title>
    <meta name="generator" content="Hugo 0.53" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://kainlite.github.io/css/main.css" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/tomorrow.min.css">
    
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old" />
    
    <!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-8919037-7', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </head>

  <body>
    <div id="wrap">

      
      <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://kainlite.github.io/"><i class="fa fa-home"></i></a>
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/blog/">BLOG</a></li>
        
      
      </ul>
    </div>
  </div>
</nav>

      
      <div class="container">
        <div class="blog-post">
          <h3>
            <strong><a href="https://kainlite.github.io/blog/go_echobot/">Go echo bot</a></strong>
          </h3>
        </div>
        <div class="blog-title">
          <h4>
          December 29, 2018
            &nbsp;&nbsp;
            
            <span class="label label-success">ksonnet</span>
            
            <span class="label label-success">jsonnet</span>
            
            <span class="label label-success">deployments</span>
            
          </h4>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="blogpost">
              

<h3 id="echo-bot"><strong>Echo bot</strong></h3>

<p>To be honest, there is no other way to get the benefits of having <a href="https://ksonnet.io/">ksonnet</a> if you&rsquo;re not going to take advantage of the <em>deployments as code</em> facilities that it brings thanks to Jsonnet.</p>

<p>In the examples I will be using <a href="https://kubernetes.io/docs/tasks/tools/install-minikube">minikube</a> or you can <a href="https://github.com/kainlite/kainlite.github.io">check out this repo</a> that has a good overview of minikube, once installed and started (<code>minikube start</code>) that command will download and configure the local environment, if you have been following the previous posts you already have minikube installed and working:</p>

<p>This time we will see how to use <a href="https://github.com/cybermaggedon/ksonnet-cheat-sheet">proper templates</a>, it seems that the templates generated with <code>ks</code> are outdated at the time of this writing ksonnet version is: 0.13.1, no surprise here but it&rsquo;s not a really mature tool. It does require a lot of effort in learning, hacking and reading to get things to work, but hopefully soon it will be easier, of course this is my personal opinion and I have not used it for a real project yet, but I expect it to grow and become more usable before I attempt to do something for the real world with it.</p>

<h3 id="let-s-get-started">Let&rsquo;s get started</h3>

<p>This time I&rsquo;m not going to deploy another wordpress instance but a simple Slack echo bot made with go:</p>

<pre><code>package main

import (
        &quot;fmt&quot;
        &quot;os&quot;
        &quot;strings&quot;

        slack &quot;github.com/nlopes/slack&quot;
)

func main() {
        api := slack.New(
                os.Getenv(&quot;SLACK_API_TOKEN&quot;),
        )

        rtm := api.NewRTM()
        go rtm.ManageConnection()

        for msg := range rtm.IncomingEvents {
                fmt.Print(&quot;Event Received: &quot;)
                switch ev := msg.Data.(type) {
                case *slack.HelloEvent:
                        // Ignore hello

                case *slack.ConnectedEvent:
                        fmt.Println(&quot;Infos:&quot;, ev.Info)
                        fmt.Println(&quot;Connection counter:&quot;, ev.ConnectionCount)

                case *slack.MessageEvent:
                        // Only echo what it said to me
                        fmt.Printf(&quot;Message: %v\n&quot;, ev)
                        info := rtm.GetInfo()
                        prefix := fmt.Sprintf(&quot;&lt;@%s&gt; &quot;, info.User.ID)

                        if ev.User != info.User.ID &amp;&amp; strings.HasPrefix(ev.Text, prefix) {
                                rtm.SendMessage(rtm.NewOutgoingMessage(ev.Text, ev.Channel))
                        }

                case *slack.PresenceChangeEvent:
                        fmt.Printf(&quot;Presence Change: %v\n&quot;, ev)

                case *slack.LatencyReport:
                        fmt.Printf(&quot;Current latency: %v\n&quot;, ev.Value)

                case *slack.RTMError:
                        fmt.Printf(&quot;Error: %s\n&quot;, ev.Error())

                case *slack.InvalidAuthEvent:
                        fmt.Printf(&quot;Invalid credentials&quot;)
                        return

                default:

                        // Ignore other events..
                        // fmt.Printf(&quot;Unexpected: %v\n&quot;, msg.Data)
                }
        }
}
</code></pre>

<p>As you can see it&rsquo;s the simplest example from the wiki of the <a href="https://github.com/nlopes/slack">Go Slack API</a> wiki page, it only connects to Slack and when it reads a message if it&rsquo;s addressed to the bot then it echoes the message back, creating a bot and everything else is out of the scope of this article but it&rsquo;s really simple, you only need to create an app in the Slack workspace, set it as a bot and grab the token (there is a lot more that you can customize but that is the most basic procedure to get started with a bot), then you just invite it to any channel that you want and start interacting with it.</p>

<p>Here you can see the <code>Dockerfile</code>, for security we create an app user for the build and for running it, and to save space and bandwidth we only ship what we need using a multi-stage build:</p>

<pre><code class="language-plain"># Build
FROM golang:1.11.2-alpine as builder

WORKDIR /app
RUN adduser -D -g 'app' app &amp;&amp; \
    chown -R app:app /app &amp;&amp; \
    apk add git &amp;&amp; apk add gcc musl-dev

ADD . /app/
RUN go get -d -v ./... &amp;&amp; go build -o main . &amp;&amp; chown -R app:app /app /home/app

# Run
FROM golang:1.11.2-alpine

WORKDIR /app
RUN adduser -D -g 'app' app &amp;&amp; \
    chown -R app:app /app

COPY --from=builder --chown=app /app/main /app/main

USER app
CMD [&quot;/app/main&quot;]
</code></pre>

<p>There are a few more files in there, you can see the full sources <a href="https://github.com/kainlite/echobot">here</a>, for example <code>health_check.sh</code>, as our app doesn&rsquo;t listen on any port we need a way to tell kubernetes how to check or know that our app is alive, otherwise it will murder the pod over and over again.</p>

<p>Okay, enough boilerplate let&rsquo;s get to business, so let&rsquo;s create a new ksonnet application:</p>

<pre><code class="language-bash">$ ks init echobot
INFO Using context &quot;minikube&quot; from kubeconfig file &quot;/home/kainlite/.kube/config&quot;
INFO Creating environment &quot;default&quot; with namespace &quot;default&quot;, pointing to &quot;version:v1.8.0&quot; cluster at address &quot;https://192.168.99.100:8443&quot;
INFO Generating ksonnet-lib data at path '/home/kainlite/Webs/echobot/echobot/lib/ksonnet-lib/v1.8.0'
</code></pre>

<p>And now based let&rsquo;s create the deployment for it <code>echobot.jsonnet</code>:</p>

<pre><code>// Import KSonnet library
local params = std.extVar('__ksonnet/params').components.demo;
local k = import 'k.libsonnet';

// Specify the import objects that we need
local container = k.extensions.v1beta1.deployment.mixin.spec.template.spec.containersType;
local depl = k.extensions.v1beta1.deployment;

// Environment variables, instead of hardcoding it here we could use a param or a secret
// But I will leave that as an exercise for you :)
local envs = [
  {
    name: 'SLACK_API_TOKEN',
    value: 'really-long-token',
  },
];

// Define containers
local containers = [
  container.new('echobot', 'kainlite/echobot:0.0.1') {
    env: (envs),
  },
];

// Define deployment with 3 replicas
local deployment =
  depl.new('echobot', 1, containers, { app: 'echobot' });

local resources = [deployment];

// Return list of resources.
k.core.v1.list.new(resources)
</code></pre>

<p>Note that I have uploaded that image to docker hub so you can use it to follow the example if you want, after that just replace <code>really-long-token</code> with your token, and then do:</p>

<pre><code class="language-plain">$ ks apply default
INFO Applying deployments echobot
INFO Creating non-existent deployments echobot
</code></pre>

<p>And now if we check our deployment and pod, we should see something like this:</p>

<p><img src="/img/echobot.png" alt="Echo bot" /></p>

<p>And in the logs:</p>

<pre><code class="language-plain"> $ kubectl get pods
NAME                               READY     STATUS    RESTARTS   AGE
echobot-7456f7d7dd-twg4r           1/1       Running   0          53s

$ kubectl logs -f echobot-7456f7d7dd-twg4r
Event Received: Event Received: Infos: &amp;{wss://cerberus-xxxx.lb.slack-msgs.com/websocket/1gvXP_yQCFE-Y= 0xc000468000 0xc0004482a0 [] [] [] [] []}
Connection counter: 0
Event Received: Event Received: Current latency: 1.256397423s
Event Received: Current latency: 1.25679313s
Event Received: Current latency: 1.256788737s
Event Received: Message: &amp;{{message CEDGU6EA0 UEDJT5DDH &lt;@UED48HD33&gt; echo! 1546124966.002300  false [] [] &lt;nil&gt;  false 0  false  1546124966.002300   &lt;nil&gt;      [] 0 []  [] false &lt;nil&gt;  0 TEDJT5CTD []  false false} &lt;nil&gt;}
</code></pre>

<p>And that folks is all I have for now, I hope you enjoyed this small tour of ksonnet. The source code for the bot can be found <a href="here">https://github.com/kainlite/echobot</a>. In a future post I might explore <a href="https://ksonnet.io/docs/examples/helm/">ksonnet and helm charts</a>.</p>

<h3 id="upcoming-topics">Upcoming topics</h3>

<p>As promised I will be doing one post about <a href="https://github.com/hasura/gitkube">Gitkube</a> and <a href="https://github.com/GoogleContainerTools/skaffold">Skaffold</a>, there are a lot of deployment tools for kubernetes but those are the most promising ones to me, also after that I will start covering more topics about <a href="https://www.docker.com/">Docker</a>, <a href="https://containerd.io/">ContainerD</a>, <a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">KubeADM</a>, and Kubernetes in general.</p>

<h3 id="errata">Errata</h3>

<p>If you spot any error or have any suggestion, please send me a message so it gets fixed.</p>

<p>Also, you can check the source code and changes in the <a href="https://github.com/kainlite/kainlite.github.io">generated code</a> and the <a href="https://github.com/kainlite/blog">sources here</a></p>

              <hr>
              
              <div class="related-posts">
                <h5>Related Posts</h5>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        December 27, 2018
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/getting_started_with_ksonnet/">Getting started with ksonnet</a></strong>
                      </h6>
                    </div>
                  </div>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        December 24, 2018
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/deploying_my_apps_with_helm/">Deploying my apps with Helm</a></strong>
                      </h6>
                    </div>
                  </div>
                
                  <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                      <h6 style="text-align: right">
                        December 23, 2018
                      </h6>
                    </div>
                    <div class="col-sm-8 col-md-8 col-lg-8">
                      <h6 style="text-align: left">
                        <strong><a href="/blog/getting_started_with_helm/">Getting started with Helm</a></strong>
                      </h6>
                    </div>
                  </div>
                
              </div>
            </div>
          </div>
          
          <hr>
        <div class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">

    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;

      var disqus_shortname = 'kainlite';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        </div>
      </div>
      
    </div>

    
    <footer>
  <div id="footer">
    <div class="container">
      <p class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
      <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with â™¥</p>
    </div>
  </div>
</footer>
<div class="footer"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://kainlite.github.io/js/docs.min.js"></script>
<script src="https://kainlite.github.io/js/main.js"></script>

<script src="https://kainlite.github.io/js/ie10-viewport-bug-workaround.js"></script><!-- Syntax highlighting -->
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  </body>
</html>
